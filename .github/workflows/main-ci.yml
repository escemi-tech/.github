name: Main CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  ci:
    name: CI Pipeline
    uses: ./.github/workflows/shared-ci.yml
    permissions:
      actions: read
      contents: read
      id-token: write
      packages: read
      pull-requests: write
      statuses: write
      security-events: write

  update-pdfs:
    name: Commit PDFs
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - id: get-pdfs-artifacts-ids
        name: Get PDFs Artifacts IDs
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GENERATED_PDFS: ${{ needs.ci.outputs.generated-pdfs }}
        with:
          result-encoding: string
          script: |
            const generatedPdfs = JSON.parse(process.env.GENERATED_PDFS);
            return generatedPdfs.map(pdf => pdf["artifact-id"]).join(',');

            return artifactIds;

      - name: Download PDFs
        id: download-pdfs
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          artifact-ids: ${{ steps.get-pdfs-artifacts-ids.outputs.result }}
          path: ${{ runner.temp }}/generated-pdfs-${{ github.run_id }}

      - name: Copy generated PDFs
        env:
          DOWNLOAD_PATH: ${{ steps.download-pdfs.outputs.download-path }}
          DESTINATION_PATH: ${{ needs.ci.outputs.pdfs-root-path }}
        run: |
          ls -la ${{ env.DOWNLOAD_PATH }}/**/*.pdf
          rm -f ${{ env.DESTINATION_PATH }}/*.pdf
          cp ${{ env.DOWNLOAD_PATH }}/**/*.pdf ${{ env.DESTINATION_PATH }}/
          ls -la ${{ env.DESTINATION_PATH }}

      - name: Upload resumes artifact
        id: upload-resumes
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: resumes
          path: |
            resume/resume.*.json
            resume/pdf/resume.*.pdf
          if-no-files-found: error

      - uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@b17226e57c8ef31f860719766656ebb6df017218 # 0.31.6
        with:
          branch: chore/update-resume-pdfs
          commit-message: "chore(resume): update generated resume PDFs"
          title: "chore(resume): update generated resume PDFs"
          body: |
            This PR updates the generated resume PDF files.

            The PDFs are generated automatically from the JSON resume data.

            [skip ci]

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ vars.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Dispatch sync-resumes event
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697 # v4.0.1
        with:
          event-type: sync-resumes
          token: ${{ steps.generate-token.outputs.token }}
          repository: ${{ github.repository_owner }}/escemi-website
          client-payload: |
            {
              "repository": ${{ toJson(github.repository) }},
              "run-id": ${{ toJson(github.run_id) }},
              "artifact-id": ${{ toJson(steps.upload-resumes.outputs.artifact-id) }}
            }
