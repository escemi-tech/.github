name: Resume Sync

on:
  push:
    branches:
      - main
    paths:
      - 'resume/resume.en.json'
      - 'resume/resume.fr.json'
  pull_request:
    paths:
      - 'resume/resume.en.json'
      - 'resume/resume.fr.json'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Resume
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate JSON structure
        run: |
          echo "Validating resume files..."
          
          if ! jq empty resume/resume.en.json 2>/dev/null; then
            echo "âŒ Invalid JSON format in resume.en.json"
            exit 1
          fi
          echo "âœ… resume.en.json structure is valid"
          
          if ! jq empty resume/resume.fr.json 2>/dev/null; then
            echo "âŒ Invalid JSON format in resume.fr.json"
            exit 1
          fi
          echo "âœ… resume.fr.json structure is valid"
      
      - name: Check required fields
        run: |
          echo "Checking required fields..."
          
          # Check English resume
          if ! jq -e '.basics.name' resume/resume.en.json > /dev/null; then
            echo "âŒ Missing basics.name in resume.en.json"
            exit 1
          fi
          if ! jq -e '.basics.label' resume/resume.en.json > /dev/null; then
            echo "âŒ Missing basics.label in resume.en.json"
            exit 1
          fi
          if ! jq -e '.basics.summary' resume/resume.en.json > /dev/null; then
            echo "âŒ Missing basics.summary in resume.en.json"
            exit 1
          fi
          echo "âœ… resume.en.json has all required fields"
          
          # Check French resume
          if ! jq -e '.basics.name' resume/resume.fr.json > /dev/null; then
            echo "âŒ Missing basics.name in resume.fr.json"
            exit 1
          fi
          if ! jq -e '.basics.label' resume/resume.fr.json > /dev/null; then
            echo "âŒ Missing basics.label in resume.fr.json"
            exit 1
          fi
          if ! jq -e '.basics.summary' resume/resume.fr.json > /dev/null; then
            echo "âŒ Missing basics.summary in resume.fr.json"
            exit 1
          fi
          echo "âœ… resume.fr.json has all required fields"
      
      - name: Display resume summary
        run: |
          echo "## Resume Summary"
          echo ""
          echo "**Name:** $(jq -r '.basics.name' resume/resume.en.json)"
          echo ""
          echo "**English Label:**"
          jq -r '.basics.label' resume/resume.en.json
          echo ""
          echo "**French Label:**"
          jq -r '.basics.label' resume/resume.fr.json
          echo ""
          echo "**LinkedIn Profile:**"
          jq -r '.basics.profiles[] | select(.network == "LinkedIn") | .url' resume/resume.en.json

  notify-update:
    name: Notify LinkedIn Update
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create LinkedIn Update Reminder
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resumeEn = JSON.parse(fs.readFileSync('resume/resume.en.json', 'utf8'));
            const resumeFr = JSON.parse(fs.readFileSync('resume/resume.fr.json', 'utf8'));
            
            const issueTitle = 'ðŸ”„ Resume Updated - Update LinkedIn Profile';
            const issueBody = `
            ## Resume has been updated
            
            The resume data has been updated. Please update the LinkedIn profile accordingly.
            
            ### Current Information
            
            **Name:** ${resumeEn.basics.name}
            
            **LinkedIn Profile:** ${resumeEn.basics.profiles.find(p => p.network === 'LinkedIn')?.url || 'Not specified'}
            
            ### English Version
            
            **Headline:** ${resumeEn.basics.label}
            
            **About:**
            \`\`\`
            ${resumeEn.basics.summary}
            \`\`\`
            
            ### French Version
            
            **Headline:** ${resumeFr.basics.label}
            
            **About:**
            \`\`\`
            ${resumeFr.basics.summary}
            \`\`\`
            
            ### Action Required
            
            1. Review the changes in resume.en.json and resume.fr.json
            2. Log in to [LinkedIn](https://www.linkedin.com)
            3. Update your profile with the new information:
               - Update headline/title
               - Update about/summary section
               - Update work experience if changed
               - Update skills if changed
            4. Close this issue once LinkedIn is updated
            
            ### Note on Automation
            
            LinkedIn's Profile Edit API is restricted to approved LinkedIn Partner Program applications. 
            Automated profile updates require partnership approval from LinkedIn.
            
            To automate this in the future:
            - Apply for [LinkedIn Partner Program](https://developer.linkedin.com/partner-programs)
            - Once approved, update this workflow to use the LinkedIn API
            
            ---
            
            *This issue was automatically created by the Resume Sync workflow.*
            *Commit: ${context.sha}*
            `;
            
            // Check if an open issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'resume-update'
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              console.log('Updating existing issue...');
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: issueBody
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              console.log('Creating new issue...');
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['resume-update', 'manual-action-required']
              });
              console.log(`Created issue #${issue.data.number}`);
            }
